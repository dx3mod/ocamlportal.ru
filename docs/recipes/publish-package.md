# Публикация пакета

Центральный репозиторий пакетов для OCaml называется [opam-repository](https://github.com/ocaml/opam-repository) и является GitHub-репозиторием, содержащий файлы манифестов.

## Публикация

Чтобы опубликовать ваш проект в opam-репозитории и сделать его общедоступным вам потребуется:

1. Во-первых манифест проекта, файл [`<название-проекта>.opam`](https://opam.ocaml.org/doc/Packaging.html#Creating-a-package-definition-file). Самый простой и современный способ его получить &mdash; использовать [Dune](../tools/dune.md);
2. Во-вторых GitHub-аккаунт для работы с репозиторием и [настроенные SSH-ключи](https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent)
   1. ```sh
      $ ssh-keygen -t ed25519 -C "your_email@example.com"
      $ eval "$(ssh-agent -s)"
      $ ssh-add ~/.ssh/id_ed25519
      ```
   2. Добавьте содержимое `~/.ssh/id_ed25519.pub` в настройки пользователя
3. Ну и Git само собой...

> [!NOTE] Документация
>
> - https://opam.ocaml.org/doc/Packaging.html#Creating-a-package-definition-file
> - https://github.com/ocaml/opam-repository/blob/master/CONTRIBUTING.md

> [!TIP] Рекомендации и возможные ошибки
> Чётко указывайте версии зависимостей, в том числе для пакетов-компаньонов вашего проекта.
> Отнеситесь к этому достаточно дотошно, иначе потратите много времени.

> [!NOTE] Принцип
>
> Если кратко, то внесение проекта в opam-репозиторий происходит посредством добавления файла манифеста в дерево репозитория.
> Например, манифест проекта с название `xyz` и версией `1.2.3` будет располагаться по пути `packages/xyz/xyz.1.2.3/opam`.
>
> У такого манифеста должно быть указано поле `url` с информацией откуда достать исходный код проекта:
>
> ```opam
> url {
>   src: "https://address/of/project.1.0.tar.gz"
>   checksum: "md5=3ffed1987a040024076c08f4a7af9b21"
> }
> ```

### opam-publish

К счастью, для автоматизации процесса публикации существует специальная утилита `opam-publish`, которая является плагином к `opam`.

<!-- Достаточно создать тег для фиксации последней версии проекта и выполнить команду `opam publish`. -->

> [!TIP] Установка
> Рекомендуется установить утилиту в отдельный switch, так как она требовательна к версиям зависимостей и может сделать downgrade многих установленных пакетов.
>
> ```sh
> $ opam switch create publish 5.2.0
> $ opam install opam-publish
> ```

Для публикации пакета с помощью утилиты необходимо создать тег и сделать его доступным из Интернета.
Пример из документации:

```sh
$ git tag -a 0.1
$ git push origin 0.1

$ opam publish
```

После чего утилита попросит ввести GitHub-токен, она сделает форк opam-репозитория и создаст pull-request (PR), где начнется автоматизированное тестирования на сборку платформой [ocaml-ci](https://ocaml.ci.dev/).

> [!NOTE] Исправление ошибок
>
> ```sh
> $ git tag -f tag
> $ git push -f origin tag
> ```

### Принятие

После того как вы исправите все свои косяки, ваш PR сольют с репозиторием и вы сможете установить
пакет обычным `opam install`.

## Факапы

:::details revdeps

Ошибка при сборки обратных зависимостей.

> [!NOTE] Пример
> ![](https://i.ibb.co/yBm59wy/image.png)

> [!INFO] Причина
> Скорее всего вы сломали API библиотеки, а предыдущие версия в зависимостях имела открытый ограничитель.
> Например, вы добавляете версию `0.3` вашей библиотеки, где существенно изменили API, а библиотека версии `0.2` имеет зависимость `(lib (>= 0.2))` (открытый ограничитель). В результате чего и падает сборка, так как пытается собрать старый пакет с новой версией библиотеки.

> [!IMPORTANT] Решение
> Измените ограничитель прошлых версией библиотек. [Пример](https://github.com/ocaml/opam-repository/pull/26624/files). Для этого придётся ручками править файлы в репозитории, либо воспользоваться `opam admin add-constraint`.

:::

:::details conf-pkg-config.3 failed to build

> [!NOTE] Пример
> ![](https://i.ibb.co/9cRQNS6/image.png)

> [!IMPORTANT] Решение
> Ждите вмешательство ментейнера, это не ваша ошибка. 

:::

